<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏•‡∏≤‡∏ô‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏ä‡∏≤‡∏î‡∏Å AI (Jataka Tales Studio)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Traditional Thai Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&family=Maitree:wght@300;500;700&family=Charm:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* Theme: Ancient Thai Manuscript / Earthy Tones */
        :root {
            --paper-bg: #f5f0e6;
            --paper-texture: #e8e0d5;
            --text-primary: #4a3b2a;
            --accent-gold: #b8860b;
            --accent-rust: #8b4513;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #2c241b; /* Dark wood background */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%233e3226' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            color: var(--text-primary);
            min-height: 100vh;
        }

        h1, h2, h3, .thai-serif {
            font-family: 'Maitree', serif;
        }
        
        .script-font {
            font-family: 'Charm', cursive;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #3e3226; }
        ::-webkit-scrollbar-thumb { background: #8b4513; border-radius: 4px; border: 1px solid #5d4037; }

        .mobile-frame {
            max-width: 480px; 
            margin: 0 auto;
            background-color: var(--paper-bg);
            min-height: 100vh;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            position: relative;
            border-left: 4px solid #1a120b;
            border-right: 4px solid #1a120b;
        }

        /* The "Peeking" Effect (Vignette) - Restored */
        .peep-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Radial gradient creates a hole in the center, dark edges */
            background: radial-gradient(circle at center, transparent 40%, rgba(20, 15, 10, 0.3) 80%, rgba(20, 15, 10, 0.8) 100%);
            pointer-events: none;
            z-index: 10;
            mix-blend-mode: multiply;
        }

        .scene-card {
            position: relative;
            width: 100%;
            aspect-ratio: 3/4; 
            background: #2a2a2a;
            overflow: hidden;
            border-bottom: 8px solid var(--paper-bg);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        .scene-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 3s ease, opacity 1s ease;
            transform-origin: center center;
        }
        
        .scene-image.loaded { 
            transform: scale(1.1); /* Restored Zoom in for movement */
        }
        
        .scene-image.loading { 
            transform: scale(1.05); 
            filter: blur(8px) sepia(50%); 
        }

        /* Text Overlay style for Jataka */
        .text-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            /* Gradient resembles old darkened paper at bottom */
            background: linear-gradient(to top, rgba(26, 18, 11, 0.95) 15%, rgba(26, 18, 11, 0.7) 60%, transparent 100%);
            padding: 80px 24px 32px 24px;
            pointer-events: none;
            z-index: 20;
        }

        .story-text {
            font-family: 'Maitree', serif; 
            color: #ffecd1; /* Light cream text */
            text-shadow: 0 2px 4px rgba(0,0,0,1);
            font-size: 1.15rem; 
            line-height: 1.7;
            font-weight: 500;
            text-align: center;
        }

        .app-header {
            background: #fdfbf7;
            background-image: url("https://www.transparenttextures.com/patterns/cream-paper.png");
            border-bottom: 3px double var(--accent-gold);
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 1.25rem 1.5rem;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .custom-input {
            width: 100%;
            padding: 12px 16px;
            background-color: #fffaf0;
            border: 1px solid #d6cbb8;
            border-radius: 8px;
            font-family: 'Sarabun', sans-serif;
            font-size: 0.95rem;
            transition: all 0.2s;
            outline: none;
            color: #5d4037;
        }
        .custom-input:focus {
            background-color: #fff;
            border-color: var(--accent-gold);
            box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.15);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8b4513 0%, #65330e 100%);
            color: #ffecd1;
            font-weight: 600;
            font-family: 'Maitree', serif;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #5d4037;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-primary:active {
            transform: scale(0.98);
            box-shadow: 0 2px 3px rgba(0,0,0,0.3);
        }
        .btn-primary:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            background: #797979;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(139, 69, 19, 0.2);
            border-left-color: var(--accent-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Traditional Pattern Decoration */
        .thai-pattern {
            height: 8px;
            background-color: var(--accent-gold);
            background-image: linear-gradient(45deg, #8b4513 25%, transparent 25%, transparent 75%, #8b4513 75%, #8b4513), 
                              linear-gradient(45deg, #8b4513 25%, transparent 25%, transparent 75%, #8b4513 75%, #8b4513);
            background-size: 10px 10px;
            background-position: 0 0, 5px 5px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(2px);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: #fffaf0;
            border: 2px solid var(--accent-gold);
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

    </style>
</head>
<body>

    <div class="mobile-frame">
        
        <!-- Header & Controls -->
        <div class="app-header" id="controlsLayer">
            <div class="thai-pattern"></div>
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-amber-900 tracking-tight flex items-center justify-center gap-2 thai-serif">
                    <span class="text-3xl">üìú</span> ‡∏•‡∏≤‡∏ô‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏ä‡∏≤‡∏î‡∏Å AI
                </h1>
                <p class="text-sm text-amber-700 font-medium mt-1 script-font text-lg">"‡∏™‡πà‡∏≠‡∏á‡∏≠‡∏î‡∏µ‡∏ï ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏ò‡∏£‡∏£‡∏° ‡∏ú‡πà‡∏≤‡∏ô‡∏†‡∏≤‡∏û‡∏ô‡∏¥‡∏°‡∏¥‡∏ï"</p>
            </div>
            
            <div id="inputSection" class="space-y-4">
                
                <div>
                    <label class="text-amber-900 text-xs font-bold uppercase tracking-wider ml-1 mb-1 block">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á / ‡∏ä‡∏≤‡∏î‡∏Å‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</label>
                    <textarea id="prompt" rows="2" class="custom-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏ç‡∏≤‡∏ä‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏™‡∏•‡∏∞, ‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢‡∏ï‡∏∑‡πà‡∏ô‡∏ï‡∏π‡∏°, ‡∏•‡∏¥‡∏á‡∏´‡∏•‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤..."></textarea>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-amber-900 text-xs font-bold uppercase tracking-wider ml-1 mb-1 block">‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô (Art Style)</label>
                        <select id="styleSelect" class="custom-input appearance-none">
                            <optgroup label="--- ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (Recommended) ---">
                                <option value="‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏¥‡∏•‡∏õ‡πå‡πÇ‡∏ö‡∏£‡∏≤‡∏ì ‡∏ú‡∏™‡∏°‡∏ú‡∏™‡∏≤‡∏ô‡∏Å‡∏•‡∏¥‡πà‡∏ô‡∏≠‡∏≤‡∏¢‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡πÅ‡∏•‡∏∞‡πÑ‡∏ó‡∏¢">‡∏û‡∏∏‡∏ó‡∏ò‡∏®‡∏¥‡∏•‡∏õ‡πå‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢-‡πÑ‡∏ó‡∏¢‡πÇ‡∏ö‡∏£‡∏≤‡∏ì</option>
                                <option value="‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏à‡∏¥‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ù‡∏≤‡∏ú‡∏ô‡∏±‡∏á‡πÑ‡∏ó‡∏¢">‡∏à‡∏¥‡∏ï‡∏£‡∏Å‡∏£‡∏£‡∏°‡∏ù‡∏≤‡∏ú‡∏ô‡∏±‡∏á (Thai Mural)</option>
                                <option value="‡∏†‡∏≤‡∏û‡∏ß‡∏≤‡∏î‡πÉ‡∏ô‡∏™‡∏°‡∏∏‡∏î‡∏Ç‡πà‡∏≠‡∏¢‡πÇ‡∏ö‡∏£‡∏≤‡∏ì">‡∏™‡∏°‡∏∏‡∏î‡∏Ç‡πà‡∏≠‡∏¢‡πÇ‡∏ö‡∏£‡∏≤‡∏ì (Parchment)</option>
                            </optgroup>
                            <optgroup label="--- ‡∏£‡πà‡∏ß‡∏°‡∏™‡∏°‡∏±‡∏¢ (Contemporary) ---">
                                <option value="‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡πÇ‡∏ô‡πÄ‡∏ß‡∏•, ‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÑ‡∏ó‡∏¢‡∏ú‡∏™‡∏°‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡πÇ‡∏ö‡∏£‡∏≤‡∏ì, ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏¢‡∏¢‡πâ‡∏≠‡∏ô‡∏¢‡∏∏‡∏Ñ, ‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô‡∏Ñ‡∏°‡∏ä‡∏±‡∏î">‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å‡πÇ‡∏ô‡πÄ‡∏ß‡∏• (Thai-Indian Style)</option>
                                <option value="‡∏á‡∏≤‡∏ô‡∏õ‡∏±‡πâ‡∏ô‡∏î‡∏¥‡∏ô‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 3 ‡∏°‡∏¥‡∏ï‡∏¥">‡∏î‡∏¥‡∏ô‡∏õ‡∏±‡πâ‡∏ô 3D (Clay Animation)</option>
                                <option value="‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏ï‡∏π‡∏î‡∏¥‡πÇ‡∏≠‡∏à‡∏¥‡∏ö‡∏£‡∏¥">‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏ä‡∏±‡πà‡∏ô (Ghibli Style)</option>
                                <option value="‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ã‡πâ‡∏≠‡∏ô‡∏ä‡∏±‡πâ‡∏ô">‡∏®‡∏¥‡∏•‡∏õ‡∏∞‡∏ï‡∏±‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏© (Papercut)</option>
                            </optgroup>
                        </select>
                    </div>
                    <div>
                        <label class="text-amber-900 text-xs font-bold uppercase tracking-wider ml-1 mb-1 block">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß (‡∏â‡∏≤‡∏Å)</label>
                        <select id="sceneCount" class="custom-input appearance-none">
                            <option value="5">5 ‡∏â‡∏≤‡∏Å (‡∏™‡∏±‡πâ‡∏ô)</option>
                            <option value="8" selected>8 ‡∏â‡∏≤‡∏Å (‡∏û‡∏≠‡∏î‡∏µ)</option>
                            <option value="12">12 ‡∏â‡∏≤‡∏Å (‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)</option>
                            <option value="24">24 ‡∏â‡∏≤‡∏Å (‡∏°‡∏´‡∏≤‡∏Å‡∏≤‡∏û‡∏¢‡πå)</option>
                        </select>
                    </div>
                </div>

                <button id="generateBtn" onclick="startStory()" class="btn-primary w-full flex items-center justify-center gap-2 mt-4">
                    <i class="fas fa-dharmachakra"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏≤‡∏Ç‡∏≤‡∏ô‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô
                </button>
            </div>

            <!-- Status & Progress -->
            <div id="statusSection" class="hidden mt-4 pt-4 border-t border-amber-200 animate-fade-in">
                <div class="flex justify-between items-center text-xs font-semibold text-amber-800 mb-2">
                    <span id="statusText"><i class="fas fa-circle-notch fa-spin mr-1"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏£‡∏∂‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß...</span>
                    <span id="progressText" class="bg-amber-100 border border-amber-200 px-2 py-0.5 rounded-full text-amber-800">0/0</span>
                </div>
                <div class="h-1.5 bg-amber-100 rounded-full overflow-hidden w-full border border-amber-200">
                    <div id="progressFill" class="h-full bg-gradient-to-r from-amber-600 to-yellow-600 w-0 transition-all duration-500 ease-out"></div>
                </div>
                
                <button 
                    id="downloadAllBtn"
                    onclick="downloadAllImages()"
                    class="hidden w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 rounded-lg shadow-md transition-all text-base flex items-center justify-center gap-2 mt-6 font-serif border border-green-900">
                    <i class="fas fa-images text-xl"></i> 
                    <span>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏ù‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (.zip)</span>
                </button>
            </div>
            
            <div id="errorBox" class="mt-3 p-3 bg-red-50 border border-red-100 text-red-800 text-xs rounded-lg hidden flex items-center gap-2">
                <i class="fas fa-exclamation-circle"></i> <span id="errorText"></span>
            </div>
        </div>

        <!-- Story Feed -->
        <div id="storyFeed" class="pb-24 pt-2 bg-[#f5f0e6] min-h-[500px]">
            <!-- Placeholder -->
            <div id="placeholder" class="flex flex-col items-center justify-center h-80 text-amber-800/40 text-center p-8">
                <div class="w-24 h-24 border-4 border-amber-800/20 rounded-full flex items-center justify-center mb-4 text-4xl">
                    <i class="fas fa-eye"></i>
                </div>
                <p class="text-sm font-serif">"‡∏î‡∏ß‡∏á‡∏ï‡∏≤‡πÄ‡∏´‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°"<br>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏≠‡∏ö‡∏î‡∏π‡∏≠‡∏î‡∏µ‡∏ï‡∏ä‡∏≤‡∏ï‡∏¥</p>
            </div>
        </div>

    </div>

    <!-- Edit Prompt Modal -->
    <div id="editPromptModal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 border-b border-amber-200 pb-2">
                <h3 class="text-lg font-bold text-amber-900 thai-serif" id="modalTitle">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏¥‡∏°‡∏¥‡∏ï (Edit Prompt)</h3>
                <button onclick="closeEditModal()" class="text-amber-800 hover:text-amber-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p class="text-xs text-amber-700 mb-2">‡∏ó‡πà‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÄ‡∏õ‡πá‡∏ô **‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢** ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ô‡∏≥‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏ô‡∏¥‡∏°‡∏¥‡∏ï‡πÉ‡∏´‡∏°‡πà</p>
            <textarea id="modalPromptInput" rows="6" class="w-full p-3 border border-amber-300 rounded-lg text-sm mb-4 bg-white font-mono text-gray-700"></textarea>
            <div class="flex gap-2">
                <button onclick="closeEditModal()" class="flex-1 py-2 rounded-lg border border-amber-300 text-amber-800 hover:bg-amber-50 font-medium font-serif">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="modalSaveBtn" class="flex-1 py-2 rounded-lg bg-amber-700 text-white hover:bg-amber-800 font-medium shadow-md font-serif">
                    <i class="fas fa-paint-brush mr-1"></i> ‡∏ß‡∏≤‡∏î‡πÉ‡∏´‡∏°‡πà
                </button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = "AIzaSyAgXgxYnjHNSl-zfvLWEcHS0b6mmoI9o48"; // System will provide API Key
        const IMAGE_MODEL = "imagen-4.0-generate-001"; // Reverted to stable 3.0
        const TEXT_MODEL = "gemini-2.5-flash-preview-09-2025"; // Fixed typo (was 3flash)
        
        let generatedScenesData = [];
        let currentStoryText = "";
        let currentSessionData = {}; 
        let currentEditingScene = null;
        
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        // Robust API Request with Retry and Better Error Handling
        async function apiRequest(url, payload, retries = 5, onStatusUpdate = null) {
            let delay = 2000;
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Handle specific HTTP errors
                    if (!response.ok) {
                        // 401 Unauthorized or 403 Forbidden: Stop retrying immediately
                        if (response.status === 401 || response.status === 403) {
                            throw new Error(`Auth Error (${response.status})`);
                        }
                        
                        // Retry on 429 (Too Many Requests) or 5xx (Server Errors)
                        if (response.status === 429 || response.status >= 500) {
                            throw new Error(`Server Busy (Status ${response.status})`);
                        }
                        
                        // For other client errors (400, 403), try to get error details
                        const errorText = await response.text();
                        try {
                            const errorJson = JSON.parse(errorText);
                            throw new Error(errorJson.error?.message || `API Error: ${response.status} ${response.statusText}`);
                        } catch (parseError) {
                             throw new Error(errorText || `API Error: ${response.status} ${response.statusText}`);
                        }
                    }

                    const text = await response.text();
                    if (!text) throw new Error("Empty response from API (No content received)");

                    try {
                        const data = JSON.parse(text);
                        if (data.error) throw new Error(data.error.message);
                        return data;
                    } catch (e) {
                        throw new Error(`Invalid JSON response: ${text.substring(0, 50)}...`);
                    }

                } catch (e) {
                    console.error(`Attempt ${i+1} failed:`, e.message);
                    
                    // Stop Logic: If Auth Error, don't retry
                    if (e.message.includes("Auth Error") || e.message.includes("API Key") || e.message.includes("401") || e.message.includes("403")) {
                        throw e; // Throw immediately to break the loop
                    }
                    
                    // Standard Retry Logic
                    const isRetryable = e.message.includes("Server Busy") || e.message.includes("Empty response") || e.message.includes("Failed to fetch");
                    
                    if (i === retries - 1 || !isRetryable) {
                         if (i === retries - 1) throw e;
                         if (e.message.includes("400")) throw e;
                    }

                    if (onStatusUpdate) {
                         const waitTime = delay / 1000;
                         for(let d = waitTime; d > 0; d--) {
                            onStatusUpdate(`‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà... (${d}s)`); 
                            await sleep(1000);
                        }
                    } else {
                        await sleep(delay);
                    }
                    delay *= 2;
                }
            }
        }

        async function startStory() {
            const promptText = document.getElementById('prompt').value.trim();
            // Removed charDesignInput variable as element was removed
            // Moral Input is removed, so we default to standard theme
            const behaviorInput = "Buddhist Jataka Morals"; 
            
            const sceneCount = parseInt(document.getElementById('sceneCount').value); 
            const styleSelect = document.getElementById('styleSelect');
            const selectedStyle = styleSelect.value;
            const selectedStyleName = styleSelect.options[styleSelect.selectedIndex].text;
            
            const feed = document.getElementById('storyFeed');
            const inputSection = document.getElementById('inputSection');
            const statusSection = document.getElementById('statusSection');
            const statusText = document.getElementById('statusText');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const errorBox = document.getElementById('errorBox');
            const errorText = document.getElementById('errorText');
            const downloadBtn = document.getElementById('downloadAllBtn');

            if (!promptText) {
                errorText.textContent = "‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ä‡∏≤‡∏î‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏≤‡∏ö";
                errorBox.classList.remove('hidden');
                return;
            }

            // Reset UI
            feed.innerHTML = "";
            generatedScenesData = [];
            currentStoryText = "";
            currentSessionData = {}; 
            inputSection.classList.add('hidden'); 
            statusSection.classList.remove('hidden');
            downloadBtn.classList.add('hidden');
            errorBox.classList.add('hidden');

            try {
                // 1. Generate Text (Gemini) - JATAKA MODE
                statusText.innerHTML = `<i class="fas fa-scroll fa-spin mr-1"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô...`;
                
                const textUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${apiKey}`;
                
                const textPayload = {
                    contents: [{ parts: [{ text: `
                    Role: Expert Jataka Storyteller (‡∏ô‡∏±‡∏Å‡πÄ‡∏•‡πà‡∏≤‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏ä‡∏≤‡∏î‡∏Å).
                    Task: Create a Jataka-style story with ${sceneCount} scenes about: "${promptText}".
                    
                    **‡∏Å‡∏é‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î (ABSOLUTE ‚Äî ‡∏´‡πâ‡∏≤‡∏°‡∏ù‡πà‡∏≤‡∏ù‡∏∑‡∏ô):**
                    1. **‡∏†‡∏≤‡∏û‡∏ô‡∏¥‡πà‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (Single Static Scene):** ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô ‚Äú‡πÉ‡∏ô‡πÄ‡∏™‡∏µ‡πâ‡∏¢‡∏ß‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‚Äù ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ñ‡∏±‡∏î‡πÑ‡∏õ‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î.
                    2. **‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°‡∏â‡∏≤‡∏Å‡∏≠‡∏∑‡πà‡∏ô (No montage):** ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏£‡∏¥‡∏ö‡∏ó ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°‡∏´‡∏•‡∏≤‡∏¢‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå.
                    3. **‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (No multiple moments):** ‡∏´‡πâ‡∏≤‡∏°‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô.
                    4. **‡∏´‡πâ‡∏≤‡∏°‡∏†‡∏≤‡∏û‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö (No overlapping):** ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏á‡∏≤ ‡∏†‡∏≤‡∏û‡∏™‡∏∞‡∏ó‡πâ‡∏≠‡∏ô silhouette ‡∏´‡∏£‡∏∑‡∏≠‡∏†‡∏≤‡∏û‡∏ó‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô‡πÉ‡∏î ‡πÜ.
                    5. **‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏â‡∏≤‡∏Å = ‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÇ‡∏•‡∏Å‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á:** ‡∏´‡πâ‡∏≤‡∏°‡∏ú‡∏™‡∏° ‡∏ö‡∏£‡∏£‡∏û‡∏ä‡∏¥‡∏ï / ‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå / ‡∏≠‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå ‡πÉ‡∏ô‡∏â‡∏≤‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß. ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏ê‡∏≤‡∏ô‡∏∞‡πÉ‡∏ô‡∏†‡∏≤‡∏û‡πÄ‡∏î‡∏µ‡∏¢‡∏ß. ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ ‚Äú‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô ‡∏ì ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏±‡πâ‡∏ô‚Äù ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô.
                    6. **‡∏Å‡∏é‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ (CRITICAL):** ‡∏´‡∏≤‡∏Å‡∏â‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏£‡∏∞‡∏†‡∏¥‡∏Å‡∏©‡∏∏ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏û‡∏£‡∏∞‡∏†‡∏¥‡∏Å‡∏©‡∏∏ ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö ‡∏°‡∏á‡∏Å‡∏∏‡∏é ‡∏≠‡∏≤‡∏†‡∏£‡∏ì‡πå‡∏Å‡∏©‡∏±‡∏ï‡∏£‡∏¥‡∏¢‡πå‡∏ó‡∏∏‡∏Å‡∏Å‡∏£‡∏ì‡∏µ. ‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏ñ‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏¥‡∏á‡∏ô‡∏≤‡∏°‡∏ò‡∏£‡∏£‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‚Äú‡∏û‡∏£‡∏∞‡πÇ‡∏û‡∏ò‡∏¥‡∏™‡∏±‡∏ï‡∏ß‡πå‚Äù ‡πÉ‡∏ô‡∏†‡∏≤‡∏û ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô.
                    7. **‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ (No supernatural):** ‡∏´‡πâ‡∏≤‡∏°‡∏ú‡∏µ ‡πÄ‡∏ó‡∏ß‡∏î‡∏≤ ‡∏¢‡∏±‡∏Å‡∏©‡πå ‡∏≠‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå. ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ ‡∏≠‡∏≠‡∏£‡πà‡∏≤ ‡πÅ‡∏™‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á ‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏à‡∏±‡∏Å‡∏£. ‡∏´‡πâ‡∏≤‡∏°‡∏†‡∏≤‡∏û‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏õ‡∏£‡∏¢.
                    8. **‡∏Å‡∏≤‡∏£‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°:** Literal only ‚Äî ‡∏ß‡∏≤‡∏î‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏®‡∏¥‡∏•‡∏õ‡πå‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏£‡∏¥‡∏á.
                    9. **‡∏†‡∏≤‡∏©‡∏≤:** ‡πÄ‡∏£‡∏¥‡πà‡∏° prompt ‡∏†‡∏≤‡∏û‡∏ó‡∏∏‡∏Å‡∏â‡∏≤‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‚Äú‡∏†‡∏≤‡∏û‡∏ô‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á‚Ä¶‚Äù ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥ Then / Next / After / ‡∏ï‡πà‡∏≠‡∏°‡∏≤ / ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á.
                    10. **Simple & Short:** ‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏±‡πâ‡∏ô ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÄ‡∏ô‡πâ‡∏ô‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ß‡∏¥‡πà‡∏ô‡πÄ‡∏ß‡πâ‡∏≠.
                    
                    **Tone:** Sacred, Magical, Didactic (‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå, ‡∏°‡∏µ‡∏°‡∏ô‡∏ï‡πå‡∏Ç‡∏•‡∏±‡∏á). Use formal but accessible Thai storytelling language ("‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï‡∏Å‡∏≤‡∏•...", "‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô...", "‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏™‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤...").
                    **Perspective:** Narrate as if observing a past life event (Peeking into the past).
                    
                    **REQUIREMENTS:**
                    - **Last Scene:** Must be the moral lesson summary.
                    - **Characters:** Keep consistent identity description for image generation.
                    - **Safety:** Family friendly.
                    
                    Response Format (JSON Only):
                    {
                      "title": "Thai Title (e.g. ...‡∏ä‡∏≤‡∏î‡∏Å)",
                      "scenes": [
                        { "text": "Thai narrative text for this scene.", "image_prompt": "Thai visual description (‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ '‡∏†‡∏≤‡∏û‡∏ô‡∏¥‡πà‡∏á‡∏Ç‡∏≠‡∏á...'). Focus ONLY on the visible action. Literal interpretation only." }
                      ]
                    }
                    ` }] }],
                    generationConfig: { responseMimeType: "application/json" }
                };

                const textData = await apiRequest(textUrl, textPayload);
                let rawText = textData.candidates[0].content.parts[0].text;
                rawText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                const storyData = JSON.parse(rawText);
                
                // Add Title
                const titleHeader = document.createElement('div');
                titleHeader.className = "text-center py-8 px-4 mb-4 bg-[#f5f0e6]";
                titleHeader.innerHTML = `
                    <div class="inline-block border-b-2 border-amber-800 pb-2">
                        <h2 class="text-3xl font-bold text-amber-900 thai-serif">${storyData.title}</h2>
                    </div>
                `;
                feed.appendChild(titleHeader);

                currentStoryText += `‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á: ${storyData.title}\n‡∏®‡∏¥‡∏•‡∏õ‡∏∞: ${selectedStyleName}\n\n`;

                // 2. Render ALL Placeholders First
                const totalScenes = storyData.scenes.length;
                for (let i = 0; i < totalScenes; i++) {
                    const scene = storyData.scenes[i];
                    const sceneIdx = i + 1;
                    
                    // Create Card UI
                    const div = document.createElement('div');
                    div.className = 'scene-card mb-0';
                    div.id = `card-${sceneIdx}`;
                    div.innerHTML = `
                        <div class="loader-overlay absolute inset-0 bg-[#2a2a2a] flex flex-col items-center justify-center z-30" id="loader-${sceneIdx}">
                            <div class="spinner mb-3 text-amber-500"></div>
                            <span class="text-xs text-amber-200 font-medium tracking-wide">‡∏£‡∏≠‡∏Ñ‡∏¥‡∏ß‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ${sceneIdx}...</span>
                        </div>
                        
                        <!-- The Peeping Effect Overlay (Restored) -->
                        <div class="peep-overlay"></div>
                        
                        <img id="img-${sceneIdx}" class="scene-image opacity-0" alt="Scene ${sceneIdx}">
                        
                        <div class="text-overlay">
                            <p class="story-text">${scene.text}</p>
                        </div>
                        
                        <div class="absolute top-4 right-4 bg-black/60 backdrop-blur-sm text-amber-100 text-xs px-2 py-1 rounded border border-amber-900/50 z-40 font-serif">
                            ${sceneIdx}/${totalScenes}
                        </div>
                        
                        <button onclick="openEditPrompt(${sceneIdx})" class="absolute top-4 left-4 bg-white/90 hover:bg-white text-amber-900 w-8 h-8 rounded-full shadow-lg flex items-center justify-center transition-all z-40 cursor-pointer border border-amber-200" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏¥‡∏°‡∏¥‡∏ï">
                            <i class="fas fa-magic text-xs"></i>
                        </button>
                    `;
                    feed.appendChild(div);
                    
                    // Prepare data for generation
                    let finalPrompt = constructPrompt(i, selectedStyle, scene, storyData);
                    currentSessionData[sceneIdx] = {
                        prompt: finalPrompt,
                        text: scene.text,
                        rawStyle: selectedStyle
                    };
                }

                // 3. Process Image Generation Queue
                statusText.innerHTML = `<i class="fas fa-paint-brush mr-1"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏∞‡∏¢‡∏≠‡∏¢‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û...`;
                
                for (let i = 0; i < totalScenes; i++) {
                    const sceneIdx = i + 1;
                    const card = document.getElementById(`card-${sceneIdx}`);
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    progressText.textContent = `${sceneIdx}/${totalScenes}`;
                    progressFill.style.width = `${(sceneIdx / totalScenes) * 100}%`;
                    
                    await generateImageForCard(sceneIdx);
                    
                    // Safety Delay
                    if (i < totalScenes - 1) {
                        const nextLoader = document.getElementById(`loader-${sceneIdx+1}`);
                        if(nextLoader) nextLoader.querySelector('span').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ...";
                        await sleep(5000); 
                    }
                }

                statusText.innerHTML = `<i class="fas fa-check-circle text-green-700"></i> ‡∏ô‡∏¥‡∏ó‡∏≤‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏•‡πâ‡∏ß`;
                progressFill.style.backgroundColor = "#4d7c0f"; // Green

            } catch (err) {
                console.error(err);
                errorText.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message;
                errorBox.classList.remove('hidden');
                inputSection.classList.remove('hidden'); 
                statusSection.classList.add('hidden');
            }
        }

        // Updated Prompt Construction
        function constructPrompt(i, selectedStyle, scene, storyData) {
            const strictConstraints =
              "‡∏†‡∏≤‡∏û‡∏ô‡∏¥‡πà‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô, ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏ß‡∏°‡∏â‡∏≤‡∏Å‡∏≠‡∏∑‡πà‡∏ô, ‡∏´‡πâ‡∏≤‡∏°‡∏ã‡πâ‡∏≠‡∏ô‡∏ó‡∏±‡∏ö, ‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤, ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå, ‡∏´‡πâ‡∏≤‡∏°‡∏£‡∏±‡∏®‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏≠‡∏£‡πà‡∏≤, ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥, ‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô.";

            const peekingKeywords =
              "‡∏°‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏Å‡∏ß‡πâ‡∏≤‡∏á, ‡∏ñ‡πà‡∏≤‡∏¢‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡πÑ‡∏Å‡∏•, ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï‡∏Å‡∏≤‡∏£‡∏ì‡πå, ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏†‡∏≤‡∏û‡∏¢‡∏ô‡∏ï‡∏£‡πå, ‡∏†‡∏≤‡∏û‡∏Ñ‡∏°‡∏ä‡∏±‡∏î.";

            const imagePrompt = scene.image_prompt || "";
            const safeStyle = selectedStyle.replace("‡∏ã‡πâ‡∏≠‡∏ô‡∏ä‡∏±‡πâ‡∏ô", "‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß").replace("‡∏ã‡πâ‡∏≠‡∏ô‡∏•‡∏∂‡∏Å", "‡∏°‡∏¥‡∏ï‡∏¥‡πÄ‡∏î‡∏µ‡∏¢‡∏ß");

            return `‡∏â‡∏≤‡∏Å: **${imagePrompt}**
‡∏Ç‡πâ‡∏≠‡∏´‡πâ‡∏≤‡∏°: ${strictConstraints}
‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á: ${peekingKeywords}
‡∏™‡πÑ‡∏ï‡∏•‡πå: ${safeStyle}`;
        }

        // --- PROMPT EDITOR LOGIC ---
        function openEditPrompt(sceneIdx) {
            const data = currentSessionData[sceneIdx];
            if (!data) return;
            currentEditingScene = sceneIdx;
            document.getElementById('modalTitle').textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ô‡∏¥‡∏°‡∏¥‡∏ï - ‡∏â‡∏≤‡∏Å‡∏ó‡∏µ‡πà ${sceneIdx}`;
            document.getElementById('modalPromptInput').value = data.prompt;
            
            const saveBtn = document.getElementById('modalSaveBtn');
            saveBtn.onclick = () => {
                const newPrompt = document.getElementById('modalPromptInput').value;
                currentSessionData[sceneIdx].prompt = newPrompt; 
                generateImageForCard(sceneIdx); 
                closeEditModal();
            };
            document.getElementById('editPromptModal').classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editPromptModal').classList.remove('active');
            currentEditingScene = null;
        }

        async function generateImageForCard(sceneIdx) {
            const data = currentSessionData[sceneIdx];
            if (!data) return;

            const { prompt, text } = data;
            const imgEl = document.getElementById(`img-${sceneIdx}`);
            const loaderEl = document.getElementById(`loader-${sceneIdx}`);
            
            // UI Update function
            const updateLoaderText = (msg) => {
                if(loaderEl) loaderEl.querySelector('span').innerText = msg;
            };
            
            if(loaderEl) loaderEl.classList.remove('hidden');
            imgEl.classList.add('opacity-0');
            imgEl.classList.remove('loaded');

            try {
                const imagePayload = {
                    instances: [{ prompt: prompt }],
                    parameters: { sampleCount: 1, aspectRatio: "3:4" }
                };
                
                // FORCE USE IMAGEN 3.0
                const imageUrl = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL}:predict?key=${apiKey}`;
                const imageData = await apiRequest(imageUrl, imagePayload, 5, updateLoaderText);

                if (imageData && imageData.predictions?.[0]) {
                    const base64Str = imageData.predictions[0].bytesBase64Encoded;
                    
                    // Store Data
                    const existingIndex = generatedScenesData.findIndex(item => item.name.includes(`scene-${String(sceneIdx).padStart(2, '0')}`));
                    const dataObj = {
                        name: `jataka-scene-${String(sceneIdx).padStart(2, '0')}.png`,
                        data: base64Str,
                        text: text
                    };

                    if (existingIndex !== -1) {
                        generatedScenesData[existingIndex] = dataObj;
                    } else {
                        generatedScenesData.push(dataObj);
                    }

                    imgEl.src = `data:image/png;base64,${base64Str}`;
                    imgEl.onload = () => {
                        imgEl.classList.remove('opacity-0');
                        imgEl.classList.add('loaded'); 
                        if(loaderEl) loaderEl.classList.add('hidden');
                    };
                    
                    document.getElementById('downloadAllBtn').classList.remove('hidden');
                } else {
                    throw new Error("‡∏ï‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Safety Filter) - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢");
                }
            } catch (err) {
                console.error(err);
                if(loaderEl) {
                    let friendlyError = "‡∏†‡∏≤‡∏û‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢";
                    let errorColor = "text-red-300";
                    let icon = "fa-ban";
                    
                    if (err.message.includes("Safety")) {
                        friendlyError = "‡∏ï‡∏¥‡∏î‡∏Å‡∏é‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢";
                        errorColor = "text-yellow-400";
                        icon = "fa-shield-alt";
                    } else if (err.message.includes("Auth Error") || err.message.includes("401")) {
                        friendlyError = "API Key ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û (401)";
                        icon = "fa-key";
                    }
                    
                    loaderEl.innerHTML = `
                        <div class="text-center p-4 bg-black/50 rounded-xl backdrop-blur-sm border border-white/10">
                            <i class="fas ${icon} ${errorColor} text-2xl mb-2"></i><br>
                            <span class="${errorColor} text-xs mb-3 block font-bold">${friendlyError}</span>
                            <div class="flex gap-2 justify-center">
                                <button onclick="generateImageForCard(${sceneIdx})" class="bg-white/10 border border-white/20 text-white px-3 py-1.5 rounded-full text-xs hover:bg-white/20 transition-colors">
                                    <i class="fas fa-redo-alt mr-1"></i> ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
                                </button>
                                <button onclick="openEditPrompt(${sceneIdx})" class="bg-amber-600 text-white px-3 py-1.5 rounded-full text-xs hover:bg-amber-700 transition-colors shadow-lg">
                                    <i class="fas fa-pen mr-1"></i> ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á
                                </button>
                            </div>
                        </div>`;
                }
            }
        }

        // Image Processing for Download (Burning text into image)
        function processImageWithText(base64Data, text) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');

                    // Draw Image
                    ctx.drawImage(img, 0, 0);
                    
                    // Restore Peeping Vignette for Saved Image
                    const gradV = ctx.createRadialGradient(canvas.width/2, canvas.height/2, canvas.width*0.4, canvas.width/2, canvas.height/2, canvas.width);
                    gradV.addColorStop(0, 'rgba(0,0,0,0)');
                    gradV.addColorStop(1, 'rgba(20,15,10,0.6)');
                    ctx.fillStyle = gradV;
                    ctx.globalCompositeOperation = 'multiply';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.globalCompositeOperation = 'source-over';

                    // Draw Bottom Text Gradient
                    const gradient = ctx.createLinearGradient(0, canvas.height * 0.65, 0, canvas.height);
                    gradient.addColorStop(0, 'rgba(26, 18, 11, 0)');
                    gradient.addColorStop(0.3, 'rgba(26, 18, 11, 0.7)');
                    gradient.addColorStop(1, 'rgba(26, 18, 11, 0.95)');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, canvas.height * 0.65, canvas.width, canvas.height * 0.35);

                    // Text Settings
                    const fontSize = Math.floor(canvas.width * 0.05);
                    ctx.font = `500 ${fontSize}px "Maitree", serif`;
                    ctx.fillStyle = '#ffecd1';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    
                    const maxWidth = canvas.width * 0.85;
                    const x = canvas.width / 2;
                    let y = canvas.height - (canvas.height * 0.08); 
                    const lineHeight = fontSize * 1.5;

                    // Text Wrapping
                    let lines = [];
                    let currentLine = '';
                    for (let i = 0; i < text.length; i++) {
                        const char = text[i];
                        const testLine = currentLine + char;
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && i > 0) {
                            lines.push(currentLine);
                            currentLine = char;
                        } else {
                            currentLine = testLine;
                        }
                    }
                    lines.push(currentLine);

                    // Draw Text
                    lines.reverse().forEach((l, index) => {
                        ctx.shadowColor = "rgba(0,0,0,0.9)";
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetY = 2;
                        ctx.fillText(l, x, y - (index * lineHeight));
                    });

                    resolve(canvas.toDataURL('image/png').split(',')[1]);
                };
                img.src = `data:image/png;base64,${base64Data}`;
            });
        }

        async function downloadAllImages() {
            if (generatedScenesData.length === 0) return;

            const btn = document.getElementById('downloadAllBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ñ‡∏±‡∏°‡∏†‡∏µ‡∏£‡πå...`;
            btn.disabled = true;

            const zip = new JSZip();
            const folder = zip.folder("Jataka_Tales_Images");

            if (currentStoryText) {
                folder.file("story_script.txt", currentStoryText);
            }

            try {
                const promises = generatedScenesData.map(async (item) => {
                    const processedBase64 = await processImageWithText(item.data, item.text);
                    folder.file(item.name, processedBase64, {base64: true});
                });
                
                await Promise.all(promises);

                const content = await zip.generateAsync({type:"blob"});
                saveAs(content, "Jataka_Tales_AI.zip");
                
            } catch (e) {
                console.error(e);
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå");
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
